<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–æ–≤–∞—Ä—ã</title>
    <link rel="stylesheet" href="./style.css">
</head>

<body>
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ -->
    <div id="modal">
        <div id="modalContent">
            <h3>–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è</h3>
            <input id="usernameInput" type="text" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" />
            <br><br>
            <button id="saveUser">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
    </div>

    <!-- –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ -->
    <div id="app" style="display:none;">
        <h2>–¢–æ–≤–∞—Ä—ã</h2>
        <p>–ü—Ä–∏–≤–µ—Ç, <span id="userName"></span>!</p>
        <input id="search" type="text" placeholder="–ü–æ–∏—Å–∫..." />
        <div id="products"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js"
        import { getDatabase, ref, set, push, remove, onValue, get } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js"

        const firebaseConfig = {
            apiKey: "AIzaSyAg6NaVIHUW5QfnLM60L5Dk5sABqy0clok",
            authDomain: "test-project-8e64c.firebaseapp.com",
            projectId: "test-project-8e64c",
            storageBucket: "test-project-8e64c.firebasestorage.app",
            messagingSenderId: "740863324604",
            appId: "1:740863324604:web:f23d401ac37e9aa8513bb9",
            databaseURL: "https://test-project-8e64c-default-rtdb.firebaseio.com/"
        }

        const app = initializeApp(firebaseConfig)
        const db = getDatabase(app)

        const modal = document.getElementById("modal")
        const saveUserBtn = document.getElementById("saveUser")
        const usernameInput = document.getElementById("usernameInput")
        const appBox = document.getElementById("app")
        const userNameSpan = document.getElementById("userName")
        let currentUser = localStorage.getItem("username")

        // –ü–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
        function showModal() {
            modal.style.display = "flex"
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async function checkUser() {
            if (!currentUser) {
                showModal()
            } else {
                const snapshot = await get(ref(db, "users/" + currentUser))
                if (!snapshot.exists()) {
                    showModal()
                } else {
                    appBox.style.display = "block"
                    userNameSpan.textContent = currentUser
                }
            }
        }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        saveUserBtn.onclick = async () => {
            const name = usernameInput.value.trim()
            if (!name) return alert("–í–≤–µ–¥–∏—Ç–µ –∏–º—è!")
            currentUser = name
            localStorage.setItem("username", name)
            await set(ref(db, "users/" + name), { created: new Date().toISOString() })
            modal.style.display = "none"
            appBox.style.display = "block"
            userNameSpan.textContent = currentUser
        }

        checkUser()

        // ==== –¢–û–í–ê–†–´ ====
        const PRODUCTS = [
            { id: "p1", name: "Rolling stones(lp)", price: 130 },
            { id: "p2", name: "Queen(lp)", price: 180 },
            { id: "p3", name: "–ö—Ä—É–∏–∑", price: 120 },
            { id: "p4", name: "–ú–∞—à–∏–Ω–∞ –≤—Ä–µ–º–µ–Ω–∏(lp)", price: 100 },
            { id: "p5", name: "Ozzy Osbourne(lp)", price: 250 },
            { id: "p6", name: "–ú–∞–ª—å—á–∏—à–Ω–∏–∫ Sex(lp)", price: 100 },
            { id: "p7", name: "Abba(lp)", price: 140 },
            { id: "p8", name: "Dire straits(lp)", price: 100 }
        ]

        PRODUCTS.forEach(item => set(ref(db, "products/" + item.id), item))

        const container = document.getElementById("products")
        const searchInput = document.getElementById("search")

        function renderProducts(list) {
            container.innerHTML = ""
            list.forEach(product => {
                container.innerHTML += `
                <div style="border:1px solid gray; padding:10px; margin:10px;">
                    <b>${product.name}</b><br>
                    –¶–µ–Ω–∞: ${product.price} –∫–∞<br><br>

                    <input type="number" id="sell-${product.id}" placeholder="–ü—Ä–æ–¥–∞–ª –∑–∞..." />
                    <button onclick="sell('${product.id}')">–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–¥–∞–∂—É</button>
                    <button onclick="showHistory('${product.id}')">üìú –ò—Å—Ç–æ—Ä–∏—è</button>
                    <button onclick="clearHistory('${product.id}')">üóë –û—á–∏—Å—Ç–∏—Ç—å</button>

                    <div id="history-${product.id}" style="display:none; margin-top:10px; border:1px solid #ccc; padding:10px; position:relative;">
                        <button style="position:absolute; top:5px; right:5px;" onclick="closeHistory('${product.id}')">‚úñÔ∏è</button>
                        <div id="history-content-${product.id}" style="margin-top:20px;"></div>
                    </div>
                </div>`
            })
        }

        // ===== –î–û–ë–ê–í–õ–ï–ù–ò–ï –ü–†–û–î–ê–ñ–ò =====
        window.sell = function (productId) {
            if (!currentUser) return alert("–°–Ω–∞—á–∞–ª–∞ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å!")

            const input = document.getElementById("sell-" + productId)
            if (!input.value) return alert("–í–≤–µ–¥–∏—Ç–µ —Ü–µ–Ω—É!")

            const newSale = {
                price: Number(input.value),
                user: currentUser
            }

            push(ref(db, "sold/" + productId), newSale)
            input.value = ""
        }

        // ===== –ò–°–¢–û–†–ò–Ø =====
        window.showHistory = function (productId) {
            const box = document.getElementById("history-" + productId)
            const content = document.getElementById("history-content-" + productId)

            box.style.display = "block"

            onValue(ref(db, "sold/" + productId), snap => {
                const data = snap.val()
                if (!data) {
                    content.innerHTML = "<i>–ü–æ–∫–∞ –Ω–µ—Ç –ø—Ä–æ–¥–∞–∂</i>"
                    return
                }

                content.innerHTML = Object.values(data).reverse().map(sale => `
                    <div>
                        <b>üí∞ ${sale.price} –∫–∞</b><br>
                        <small>üë§ ${sale.user}</small>
                        <hr>
                    </div>
                `).join("")
            })
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –∏—Å—Ç–æ—Ä–∏–∏
        window.closeHistory = function(productId) {
            const box = document.getElementById("history-" + productId)
            box.style.display = "none"
        }

        window.clearHistory = function (productId) {
            remove(ref(db, "sold/" + productId))
        }

        onValue(ref(db, "products"), snap => {
            renderProducts(Object.values(snap.val()))
        })

        searchInput.addEventListener("input", () => {
            const q = searchInput.value.toLowerCase()
            get(ref(db, "products")).then(snap => {
                const all = Object.values(snap.val())
                renderProducts(all.filter(p => p.name.toLowerCase().includes(q)))
            })
        })
    </script>
</body>
</html>
