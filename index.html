<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Товары</title>
    <link rel="stylesheet" href="./style.css">

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
</head>
<body>
    <h2>Товары</h2>

    <input id="search" type="text" placeholder="Поиск..." />

    <div id="products"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js"
        import { getDatabase, ref, set, update, onValue } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js"

        const firebaseConfig = {
            apiKey: "AIzaSyAg6NaVIHUW5QfnLM60L5Dk5sABqy0clok",
            authDomain: "test-project-8e64c.firebaseapp.com",
            projectId: "test-project-8e64c",
            storageBucket: "test-project-8e64c.firebasestorage.app",
            messagingSenderId: "740863324604",
            appId: "1:740863324604:web:f23d401ac37e9aa8513bb9",
            measurementId: "G-J0M26HK1JM",

            databaseURL: "https://test-project-8e64c-default-rtdb.firebaseio.com/"
        }

        const app = initializeApp(firebaseConfig)
        const db = getDatabase(app)

        // ==== ТВОИ ТОВАРЫ ====
        const PRODUCTS = [
            { id: "p1", name: "Пицца Маргарита", price: 500 },
            { id: "p2", name: "Бургер Классический", price: 350 },
            { id: "p3", name: "Фри картошка", price: 150 },
            { id: "p4", name: "Шаурма Большая", price: 300 },
            { id: "p5", name: "Суши сет", price: 900 },
            { id: "p6", name: "iPhone 11 PRO MAX", price: 270 },
            { id: "p7", name: "Книги фнаф", price: 120 },
            { id: "p8", name: "Банданы", price: 40 }
        ]

        // Загружаем товары в базу 1 раз (если нужно)
        PRODUCTS.forEach(item => {
            set(ref(db, "products/" + item.id), item)
        })

        const container = document.getElementById("products")
        const searchInput = document.getElementById("search")

        // === Функция отображения ===
        function renderProducts(list, soldData) {
            container.innerHTML = ""

            list.forEach(product => {
                const sold = soldData?.[product.id]?.soldPrice ?? ""

                container.innerHTML += `
                <div style="border:1px solid gray; padding:10px; margin:10px;">
                    <b>${product.name}</b><br>
                    Цена: ${product.price} ка сум. <br><br>

                    <div class='info-box'>
                        <input type="number" id="sold-${product.id}" 
                               placeholder="За сколько продал?" 
                               value="${sold}" />
    
                        <button onclick="savePrice('${product.id}')">Сохранить</button>
                    </div>
                </div>
            `
            })
        }

        // === Сохраняем цену продажи ===
        window.savePrice = function (id) {
            const value = document.getElementById("sold-" + id).value

            update(ref(db, "sold/" + id), {
                soldPrice: Number(value)
            })

            alert("Сохранено!")
        }

        // === Читаем данные в реальном времени — товары + проданные цены ===
        onValue(ref(db, "products"), (snapshot) => {
            const products = Object.values(snapshot.val())

            onValue(ref(db, "sold"), (soldSnap) => {
                const soldData = soldSnap.val() || {}
                renderProducts(products, soldData)
            })
        })

        // === Поиск ===
        searchInput.addEventListener("input", () => {
            const query = searchInput.value.toLowerCase()

            onValue(ref(db, "products"), (snap) => {
                const products = Object.values(snap.val())
                const filtered = products.filter(p => p.name.toLowerCase().includes(query))

                onValue(ref(db, "sold"), (soldSnap) => {
                    const soldData = soldSnap.val() || {}
                    renderProducts(filtered, soldData)
                })
            })
        });
    </script>

    <script src="./app.js"></script>
</body>
</html>