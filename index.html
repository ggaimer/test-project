<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–æ–≤–∞—Ä—ã</title>
    <link rel="stylesheet" href="./style.css">

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
</head>

<body>
    <h2>–¢–æ–≤–∞—Ä—ã</h2>

    <input id="search" type="text" placeholder="–ü–æ–∏—Å–∫..." />

    <div id="products"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js"
        import { getDatabase, ref, set, push, remove, onValue, get } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js"

        const firebaseConfig = {
            apiKey: "AIzaSyAg6NaVIHUW5QfnLM60L5Dk5sABqy0clok",
            authDomain: "test-project-8e64c.firebaseapp.com",
            projectId: "test-project-8e64c",
            storageBucket: "test-project-8e64c.firebasestorage.app",
            messagingSenderId: "740863324604",
            appId: "1:740863324604:web:f23d401ac37e9aa8513bb9",
            measurementId: "G-J0M26HK1JM",
            databaseURL: "https://test-project-8e64c-default-rtdb.firebaseio.com/"
        }

        const app = initializeApp(firebaseConfig)
        const db = getDatabase(app)

        // ==== –¢–û–í–ê–†–´ ====
        const PRODUCTS = [
            { id: "p1", name: "–ü–∏—Ü—Ü–∞ –ú–∞—Ä–≥–∞—Ä–∏—Ç–∞", price: 500 },
            { id: "p2", name: "–ë—É—Ä–≥–µ—Ä –ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π", price: 350 },
            { id: "p3", name: "–§—Ä–∏ –∫–∞—Ä—Ç–æ—à–∫–∞", price: 150 },
            { id: "p4", name: "–®–∞—É—Ä–º–∞ –ë–æ–ª—å—à–∞—è", price: 300 },
            { id: "p5", name: "–°—É—à–∏ —Å–µ—Ç", price: 900 },
            { id: "p6", name: "iPhone 11 PRO MAX", price: 270 },
            { id: "p7", name: "–ö–Ω–∏–≥–∏ —Ñ–Ω–∞—Ñ", price: 120 },
            { id: "p8", name: "–ë–∞–Ω–¥–∞–Ω—ã", price: 40 }
        ]

        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–≤–∞—Ä—ã –æ–¥–∏–Ω —Ä–∞–∑
        PRODUCTS.forEach(item => set(ref(db, "products/" + item.id), item))

        const container = document.getElementById("products")
        const searchInput = document.getElementById("search")

        // === –†–ï–ù–î–ï–† –¢–û–í–ê–†–û–í ===
        function renderProducts(list) {
            container.innerHTML = ""

            list.forEach(product => {
                container.innerHTML += `
                <div style="border:1px solid gray; padding:10px; margin:10px; position: relative;">
                    <b>${product.name}</b><br>
                    –¶–µ–Ω–∞: ${product.price} —Ç—ã—â<br><br>

                    <div id='info' style="display:flex; gap:5px; align-items:center; margin-bottom:10px;">
                        <input type="number" id="sell-${product.id}" placeholder="–ü—Ä–æ–¥–∞–ª –∑–∞..." style="flex:1;"/>
                        <button onclick="sell('${product.id}')">–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–¥–∞–∂—É</button>
                        <button onclick="showHistory('${product.id}')">üìú –ò—Å—Ç–æ—Ä–∏—è</button>
                        <button onclick="clearHistory('${product.id}')">üóë –û—á–∏—Å—Ç–∏—Ç—å</button>
                    </div>

                    <div id="history-${product.id}" style="margin-top:10px; display:none; border:1px solid #ccc; padding:5px; background:#f9f9f9; position:relative;">
                        <button style="position:absolute; top:5px; right:5px;" onclick="closeHistory('${product.id}')">‚úñÔ∏è</button>
                        <div id="history-content-${product.id}" style="margin-top:20px;"></div>
                    </div>
                </div>`
            })
        }

        // === –î–û–ë–ê–í–õ–ï–ù–ò–ï –ü–†–û–î–ê–ñ–ò ===
        window.sell = function (productId) {
            const input = document.getElementById("sell-" + productId)
            if (!input.value) return alert("–í–≤–µ–¥–∏—Ç–µ —Ü–µ–Ω—É!")

            const newSale = { price: Number(input.value), time: new Date().toLocaleString() }
            push(ref(db, "sold/" + productId), newSale)
            input.value = ""
        }

        // === –ü–æ–∫–∞–∑–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é –ø—Ä–æ–¥–∞–∂ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ ===
        window.showHistory = function (productId) {
            const box = document.getElementById("history-" + productId)
            const content = document.getElementById("history-content-" + productId)
            const path = ref(db, "sold/" + productId)

            box.style.display = "block" // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –±–ª–æ–∫

            // —Å–ª—É—à–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∏—Å—Ç–æ—Ä–∏–∏
            onValue(path, snap => {
                const data = snap.val()
                if (!data || Object.keys(data).length === 0) {
                    content.innerHTML = "<i>–ü–æ–∫–∞ –Ω–µ—Ç –ø—Ä–æ–¥–∞–∂</i>"
                    return
                }

                // –ü–µ—Ä–µ–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –º–∞—Å—Å–∏–≤, —á—Ç–æ–±—ã –Ω–æ–≤—ã–µ –ø—Ä–æ–¥–∞–∂–∏ —à–ª–∏ –ø–µ—Ä–≤—ã–º–∏
                const sales = Object.values(data).reverse()

                content.innerHTML = sales
                    .map(sale => `
                <div style="margin-bottom:5px;">
                    <b>üí∞ ${sale.price} —Ç—ã—â</b><br>
                    <small>‚è≥ ${sale.time}</small>
                    <hr>
                </div>
            `).join("")
            })
        }

        // === –ó–ê–ö–†–´–¢–¨ –ò–°–¢–û–†–ò–Æ ===
        window.closeHistory = function (productId) {
            const box = document.getElementById("history-" + productId)
            box.style.display = "none"
        }

        // === –û–ß–ò–°–¢–ö–ê –ò–°–¢–û–†–ò–ò ===
        window.clearHistory = function (productId) {
            const content = document.getElementById("history-content-" + productId)
            remove(ref(db, "sold/" + productId))
                .then(() => { content.innerHTML = "<i>–ü–æ–∫–∞ –Ω–µ—Ç –ø—Ä–æ–¥–∞–∂</i>" })
                .catch(err => alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ: " + err))
        }

        // === –ó–ê–ì–†–£–ó–ö–ê –¢–û–í–ê–†–û–í ===
        onValue(ref(db, "products"), snap => {
            renderProducts(Object.values(snap.val()))
        })

        // === –ü–û–ò–°–ö ===
        searchInput.addEventListener("input", () => {
            const q = searchInput.value.toLowerCase()
            get(ref(db, "products")).then(snap => {
                const all = Object.values(snap.val())
                const filtered = all.filter(p => p.name.toLowerCase().includes(q))
                renderProducts(filtered)
            })
        })
    </script>

    <script src="app.js"></script>
</body>

</html>